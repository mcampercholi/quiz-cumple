<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Confetti para celebraci√≥n -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
</head>
<body>

  <!-- ===== NAVBAR ===== -->
  <div class="navbar">
    <div class="nav-inner">
      <!-- Izquierda: Reiniciar -->
      <div class="nav-left">
        <button class="nav-btn nav-reset" onclick="window.location.href='{{ url_for('reset') }}'">
          <span class="icon">üîÑ</span><span class="label">Reiniciar</span>
        </button>
      </div>

      <!-- Centro: marcador + vidas -->
      <div class="nav-center">
        <div class="score-board" aria-live="polite">
          <span class="score-value-led">
            <span id="nav-score">{{ score }}</span>
            <span class="score-sep">/</span>
            <span class="score-target">{{ target }}</span>
          </span>
        </div>
        <div class="lives-board"><span id="lives"></span></div>
      </div>

      <!-- Derecha: Mute -->
      <div class="nav-right">
        <button id="muteBtn" class="nav-btn" type="button">
          <span class="icon">üîá</span><span class="label">Mute</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ===== CONTENIDO ===== -->
  <div class="quiz-container">
    <div class="question-text" id="q-text">{{ question.text }}</div>

    {% if question.type == 'mc' %}
      <form method="post" class="quiz-form" id="quiz-form">
        {% for opt in question.options %}
          <button type="submit" name="answer" value="{{ opt }}" class="option-button">{{ opt }}</button>
        {% endfor %}
      </form>
    {% else %}
      <form method="post" class="quiz-form" id="quiz-form">
        <input type="text" name="answer" class="text-input" placeholder="Escrib√≠ tu respuesta" autofocus>
        <button type="submit" class="submit-button">Responder</button>
      </form>
    {% endif %}

    <div class="feedback" id="feedback"></div>
  </div>

  <!-- ===== Audio oculto ===== -->
  <audio id="quizMusic"    src="{{ url_for('static', filename='audio/quiz_music.mp3') }}" loop preload="auto"></audio>
  <audio id="sfxCorrect"   src="{{ url_for('static', filename='audio/correct.mp3') }}"  preload="auto"></audio>
  <audio id="sfxIncorrect" src="{{ url_for('static', filename='audio/incorrect.mp3') }}" preload="auto"></audio>

  <script>
    /* ===== Audio ===== */
    const quizMusic    = document.getElementById('quizMusic');
    const sfxCorrect   = document.getElementById('sfxCorrect');
    const sfxIncorrect = document.getElementById('sfxIncorrect');
    const muteBtn      = document.getElementById('muteBtn');

    let isMuted = localStorage.getItem('quiz_muted') === '1';
    function applyMute() {
      [quizMusic, sfxCorrect, sfxIncorrect].forEach(a => a.muted = isMuted);
      const lbl = muteBtn?.querySelector('.label');
      if (lbl) lbl.textContent = isMuted ? 'Unmute' : 'Mute';
      localStorage.setItem('quiz_muted', isMuted ? '1' : '0');
    }
    muteBtn?.addEventListener('click', () => { isMuted = !isMuted; applyMute(); });

    quizMusic.volume = 0.35; sfxCorrect.volume = 0.85; sfxIncorrect.volume = 0.85;
    function clonePlay(el){ if(isMuted) return; const c=el.cloneNode(true); c.volume=el.volume; c.play().catch(()=>{}); }
    function startMusic(){ quizMusic.play().catch(()=>{}); }

    document.addEventListener('DOMContentLoaded', () => {
      applyMute(); startMusic();
      const unlock = () => { startMusic(); window.removeEventListener('click', unlock); window.removeEventListener('keydown', unlock); window.removeEventListener('touchstart', unlock); };
      window.addEventListener('click', unlock, { once:true });
      window.addEventListener('keydown', unlock, { once:true });
      window.addEventListener('touchstart', unlock, { once:true });

      setLives({{ lives }}); // vidas iniciales
    });

    /* ===== Refs / helpers UI ===== */
    const qText      = document.getElementById('q-text');
    const feedbackEl = document.getElementById('feedback');
    const container  = document.querySelector('.quiz-container');

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function clearFeedback(){ feedbackEl.textContent=''; feedbackEl.classList.remove('correct','incorrect'); }

    function renderFeedback(isCorrect, correctTxt, userTxt){
      feedbackEl.classList.remove('correct','incorrect');
      feedbackEl.classList.add(isCorrect ? 'correct' : 'incorrect');
      feedbackEl.innerHTML = isCorrect
        ? `‚úÖ ¬°Biem, <strong>${escapeHtml(userTxt)}</strong> es correcto!`
        : `‚ùå Nuu... ¬øc√≥mo que <strong>${escapeHtml(userTxt)}</strong>? Obviamente era <strong>${escapeHtml(correctTxt)}</strong>!`;
    }

    function setScore(val){
      const el = document.getElementById('nav-score');
      if (!el) return;
      const n = Number(val);
      el.textContent = Number.isFinite(n) ? String(n) : String(val);
      document.querySelector('.score-board')?.classList.add('flash');
      setTimeout(()=> document.querySelector('.score-board')?.classList.remove('flash'), 350);
    }

    const TOTAL_LIVES = {{ lives }}; // = max_lives al inicio
    function setLives(n){
      const el = document.getElementById('lives');
      if (!el) return;
      n = Number(n);
      let html = '';
      for (let i=0;i<TOTAL_LIVES;i++){
        html += `<span class="heart ${i<n?'':'lost'}">‚ù§Ô∏è</span>`;
      }
      el.innerHTML = html;
    }

    function renderNextButton(){
      if (document.getElementById('nextBtn')) return;
      const wrap = document.createElement('div');
      wrap.innerHTML = `<div style="margin-top:12px">
        <button id="nextBtn" class="submit-button" type="button">Siguiente pregunta</button>
      </div>`;
      container.appendChild(wrap);
      document.getElementById('nextBtn').addEventListener('click', onNext);
    }

    function renderQuestion(q){
      qText.textContent = q.text;
      clearFeedback();
      document.getElementById('nextBtn')?.parentElement?.parentElement?.remove();

      const form = document.createElement('form');
      form.method = 'post';
      form.className = 'quiz-form';
      form.id = 'quiz-form';

      if (q.type === 'mc') {
        (q.options || []).forEach(opt => {
          const btn = document.createElement('button');
          btn.type = 'submit';
          btn.className = 'option-button';
          btn.name = 'answer';
          btn.value = opt;
          btn.textContent = opt;
          form.appendChild(btn);
        });
      } else {
        const input = document.createElement('input');
        input.type = 'text';
        input.name = 'answer';
        input.className = 'text-input';
        input.placeholder = 'Escrib√≠ tu respuesta';

        const submit = document.createElement('button');
        submit.type = 'submit';
        submit.className = 'submit-button';
        submit.textContent = 'Responder';

        form.appendChild(input);
        form.appendChild(submit);
        setTimeout(()=> input.focus(), 0);
      }

      const oldForm = document.getElementById('quiz-form');
      if (oldForm) oldForm.replaceWith(form);
      else qText.insertAdjacentElement('afterend', form);

      attachSubmitHandler();
    }

    /* ===== Confetti + CTA (solo cuando el backend lo diga) ===== */
    function shootConfetti(durationMs=1800){
      const end = Date.now() + durationMs;
      (function frame(){
        confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
        confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
        if (Date.now() < end) requestAnimationFrame(frame);
      })();
    }
    function showPrizeCTA(){
      document.getElementById('nextBtn')?.parentElement?.parentElement?.remove();
      feedbackEl.classList.remove('incorrect');
      feedbackEl.classList.add('correct');
      feedbackEl.innerHTML = `üéâ ¬°Llegaste a la meta! <strong>¬°Premio desbloqueado!</strong>`;
      const wrap = document.createElement('div');
      wrap.innerHTML = `<div style="margin-top:14px">
        <a href="{{ url_for('meta') }}" class="submit-button" style="display:inline-block;text-decoration:none;">Ir al premio</a>
      </div>`;
      container.appendChild(wrap);
    }

    /* ===== AJAX ===== */
    async function onNext(){
      const resp = await fetch('{{ url_for("next_ajax") }}', { method:'POST' });
      const data = await resp.json();
      if (data.done){
        window.location.href = data.reached_target ? '{{ url_for("meta") }}' : '{{ url_for("result") }}';
        return;
      }
      setScore(data.score);
      if (typeof data.lives !== 'undefined') setLives(data.lives);
      renderQuestion(data.question);
    }

    function attachSubmitHandler(){
      const form = document.getElementById('quiz-form');
      if (!form) return;

      form.addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const fd = new FormData(form);

        // incluir el bot√≥n presionado (MC)
        const btn = ev.submitter;
        if (btn && btn.name) fd.set(btn.name, btn.value);

        // bloquear inputs
        form.querySelectorAll('button, input').forEach(el => el.disabled = true);

        const resp = await fetch('{{ url_for("answer_ajax") }}', { method:'POST', body: fd });
        const data = await resp.json();
        if (!data || !data.ok){
          form.querySelectorAll('button, input').forEach(el => el.disabled = false);
          return;
        }

        // SFX + feedback normal
        if (data.correct) clonePlay(sfxCorrect); else clonePlay(sfxIncorrect);
        renderFeedback(data.correct, data.correct_answer, data.user_answer);

        // HUD
        setScore(data.score);
        if (typeof data.lives !== 'undefined') setLives(data.lives);

        // === SOLO reaccionamos a banderas del backend ===
        if (data.reached_target) {
          // ocultar el formulario (sirve tanto para MC como para texto)
          form.remove();
          // por si hubiera quedado un "Siguiente"
          document.getElementById('nextBtn')?.parentElement?.parentElement?.remove();
          shootConfetti(1800);
          showPrizeCTA();
          return;
        }

        if (data.game_over) {
          setTimeout(()=> { window.location.href='{{ url_for("game_over") }}'; }, 900);
          return;
        }

        // quitar form y mostrar Next
        form.remove();
        renderNextButton();
      }, { once:true });
    }

    // attach inicial
    attachSubmitHandler();
  </script>
</body>
</html>
